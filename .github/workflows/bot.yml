name: DevHub Bot

on:
  workflow_call:
    inputs:
      thank_you_message:
        description: 'Message when PR follows conventional commits'
        required: false
        default: 'Thank you for opening this PR! Repo maintainers will review it ASAP ðŸš€'
        type: string

      merge_thank_you_message:
        description: 'Message when PR is merged'
        required: false
        default: 'ðŸŽ‰ Thank you for contributing to Open DevHub! We appreciate your work.'
        type: string

    secrets:
      DEVHUB_APP_ID:
        required: true
      DEVHUB_APP_PRIVATE_KEY:
        required: true

jobs:
  pr-opened:
    if: github.event_name == 'pull_request' && github.event.action != 'closed' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Create in-progress check
        id: create-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "DevHub Bot / PR Conventions",
              head_sha: context.payload.pull_request.head.sha,
              status: "in_progress",
              output: {
                title: "Checking PR title and commits...",
                summary: "Analyzing PR title and commits for Conventional Commits"
              }
            });
            core.setOutput("check_id", check.data.id);

      - name: Fetch PR commits
        id: commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              }
            );
            core.setOutput("messages", JSON.stringify(commits.map(c => c.commit.message)));

      - name: Analyze PR title + commits
        id: analyze
        run: |
          echo '${{ steps.commits.outputs.messages }}' > commits.json

          PASS=false
          LABELS=""
          TITLE_VALID=false
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check PR title
          if [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:\ .+ ]]; then
            TITLE_VALID=true
          fi

          # Check commits
          while read -r msg; do
            if [[ "$msg" =~ ^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:\ .+ ]]; then
              TYPE=$(echo "$msg" | sed -E 's/^([a-z]+).*/\1/')
              LABELS="$LABELS $TYPE"
              PASS=true
            fi
          done < <(jq -r '.[]' commits.json)

          echo "pass=$PASS" >> $GITHUB_OUTPUT
          echo "labels=$(echo $LABELS | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

      - name: Apply labels
        if: steps.analyze.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: "${{ steps.analyze.outputs.labels }}".split(",")
            });

      - name: Update check with result
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: parseInt("${{ steps.create-check.outputs.check_id }}"),
              status: "completed",
              conclusion: "${{ steps.analyze.outputs.pass }}" === "true" ? "success" : "failure",
              output: {
                title: "DevHub Bot / PR Conventions",
                summary: "${{ steps.analyze.outputs.pass }}" === "true"
                  ? "PR title and at least one commit follow Conventional Commits."
                  : "PR title or commits do not follow Conventional Commits."
              }
            });

      - name: Thank contributor
        if: steps.analyze.outputs.pass == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `${{ inputs.thank_you_message }}`
            });

  pr-merged:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Thank contributor after merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `${{ inputs.merge_thank_you_message }}`
            });

  issue-opened:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Add bug label if title contains "bug"
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const title = context.payload.issue.title.toLowerCase();
            if (title.includes("bug")) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ["bug"]
              });
            }
