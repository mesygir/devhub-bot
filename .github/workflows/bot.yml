name: DevHub Bot

on:
  workflow_call:
    inputs:
      thank_you_message:
        description: 'Message when PR follows conventional commits'
        required: false
        default: 'Thank you for opening this PR! Repo maintainers will review it ASAP ðŸš€'
        type: string

      merge_thank_you_message:
        description: 'Message when PR is merged'
        required: false
        default: 'ðŸŽ‰ Thank you for contributing to Open DevHub! We appreciate your work.'
        type: string

      cc_warning_message:
        description: 'Message when PR does NOT follow conventional commits'
        required: false
        default: 'âš ï¸ Consider following Conventional Commits for your PR title and commit messages.'
        type: string

    secrets:
      DEVHUB_APP_ID:
        required: true
      DEVHUB_APP_PRIVATE_KEY:
        required: true

jobs:
  pr-opened:
    if: github.event_name == 'pull_request' && github.event.action != 'closed' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Fetch PR commits
        id: commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              }
            );
            core.setOutput("messages", JSON.stringify(commits.map(c => c.commit.message)));

      - name: Analyze PR title + commits for labels
        id: analyze
        run: |
          echo '${{ steps.commits.outputs.messages }}' > commits.json

          FOUND=false
          LABELS=""
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check PR title
          if [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:\ .+ ]]; then
            TYPE=$(echo "$PR_TITLE" | sed -E 's/^([a-z]+).*/\1/')
            LABELS="$LABELS $TYPE"
            FOUND=true
          fi

          # Check commits
          while read -r msg; do
            if [[ "$msg" =~ ^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:\ .+ ]]; then
              TYPE=$(echo "$msg" | sed -E 's/^([a-z]+).*/\1/')
              LABELS="$LABELS $TYPE"
              FOUND=true
            fi
          done < <(jq -r '.[]' commits.json)

          # Remove duplicates and prepare comma-separated labels
          LABELS=$(echo $LABELS | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "pass=$FOUND" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Apply labels to PR
        if: steps.analyze.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const pr_number = context.payload.pull_request.number;
            const labels = "${{ steps.analyze.outputs.labels }}".split(",");
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              labels: labels
            });

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const pr_number = context.payload.pull_request.number;
            const msg = "${{ steps.analyze.outputs.pass }}" === "true" 
                        ? `${{ inputs.thank_you_message }}`
                        : `${{ inputs.cc_warning_message }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: msg
            });

  pr-merged:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Thank contributor
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `${{ inputs.merge_thank_you_message }}`
            });

  issue-opened:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Generate DevHub Bot token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.DEVHUB_APP_ID }}
          private-key: ${{ secrets.DEVHUB_APP_PRIVATE_KEY }}

      - name: Add bug label if title contains "bug"
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const title = context.payload.issue.title.toLowerCase();
            if (title.includes("bug")) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ["bug"]
              });
            }
